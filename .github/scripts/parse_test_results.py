#!/usr/bin/env python3
"""
Parse CTest/GTest results and generate JSON summary.
Optimized for JUnit XML and accurate Total Duration parsing.
"""
import os
import sys
import json
import re
import xml.etree.ElementTree as ET
from pathlib import Path
from typing import Dict, List, Optional

def get_real_duration_from_log(build_dir: str) -> float:
    """Extract the real wall-clock time from LastTest.log."""
    try:
        log_file = Path(build_dir) / 'Testing' / 'Temporary' / 'LastTest.log'
        if log_file.exists():
            content = log_file.read_text(encoding='utf-8', errors='ignore')
            # Recherche la ligne: Total Test time (real) =   0.12 sec
            match = re.search(r'Total Test time \(real\) =\s+([\d.]+)\s+sec', content)
            if match:
                return float(match.group(1))
    except Exception:
        pass
    return 0.0

def parse_ctest_output(build_dir: str) -> Dict:
    """Parse CTest output from Testing directory (Fallback)."""
    results = {
        'total': 0, 'passed': 0, 'failed': 0, 'skipped': 0,
        'duration': 0.0, 'failed_tests': []
    }

    testing_dir = Path(build_dir) / 'Testing'

    # 1. Try Parsing standard Test.xml (Generated by -T Test)
    test_xml_files = sorted(list(testing_dir.glob('*/Test.xml')), reverse=True)
    if test_xml_files:
        try:
            tree = ET.parse(test_xml_files[0])
            root = tree.getroot()
            testing = root.find('Testing')
            if testing:
                for test in testing.findall('.//Test'):
                    results['total'] += 1
                    status = test.get('Status')
                    name = test.findtext('.//Name', 'Unknown')

                    if status == 'passed': results['passed'] += 1
                    elif status == 'failed':
                        results['failed'] += 1
                        results['failed_tests'].append(name)
                    else: results['skipped'] += 1

            # On ignore la dur√©e XML ici car elle est souvent impr√©cise pour les tests rapides
            # On laisse le main() r√©cup√©rer la dur√©e r√©elle via get_real_duration_from_log
            print(f"‚úÖ Parsed CTest XML: {test_xml_files[0]}")
            return results
        except Exception:
            pass

    # 2. Fallback: Parse LastTest.log
    last_test_log = testing_dir / 'Temporary' / 'LastTest.log'
    if last_test_log.exists():
        print("üìã Parsing LastTest.log...")
        try:
            content = last_test_log.read_text(encoding='utf-8', errors='ignore')
            # Regex simple pour compter les statuts
            # Test #1: server_tests ... Passed
            passed = len(re.findall(r'Test\s+#\d+:.*?\s+Passed', content))
            failed = len(re.findall(r'Test\s+#\d+:.*?\s+(Failed|\*\*\*Failed)', content))

            results['total'] = passed + failed
            results['passed'] = passed
            results['failed'] = failed

            # R√©cup√©rer les noms des failed
            failed_matches = re.finditer(r'Test\s+#\d+:\s+(.+?)\s+\.+\s+(Failed|\*\*\*Failed)', content)
            for m in failed_matches:
                results['failed_tests'].append(m.group(1))

        except Exception as e:
            print(f"‚ö†Ô∏è Error parsing log: {e}")

    return results

def parse_junit_xml(xml_path: str) -> Dict:
    """Parse JUnit XML output."""
    results = {
        'total': 0, 'passed': 0, 'failed': 0, 'skipped': 0,
        'duration': 0.0, 'failed_tests': []
    }
    try:
        tree = ET.parse(xml_path)
        root = tree.getroot()

        suites = root.findall('.//testsuite') or [root] if root.tag == 'testsuite' else []

        for suite in suites:
            results['total'] += int(suite.get('tests', 0))
            results['failed'] += int(suite.get('failures', 0)) + int(suite.get('errors', 0))
            results['skipped'] += int(suite.get('skipped', 0))

            # JUnit duration (sum of individual tests)
            results['duration'] += float(suite.get('time', 0))

            for case in suite.findall('testcase'):
                if case.find('failure') is not None or case.find('error') is not None:
                    results['failed_tests'].append(case.get('name', 'Unknown'))

        results['passed'] = results['total'] - results['failed'] - results['skipped']
        return results
    except Exception as e:
        print(f"‚ö†Ô∏è Error parsing JUnit: {e}")
        return results

def main():
    if len(sys.argv) < 2: return 1
    build_dir, output_file = sys.argv[1], sys.argv[2] if len(sys.argv) > 2 else 'test-results.json'

    # 1. Prioritize JUnit XML for counts (Reliable Pass/Fail)
    junit_files = list(Path(build_dir).glob('**/*test-results.xml')) + \
                  list(Path('.').glob('**/*test-results.xml'))

    final_results = {'total': 0}

    if junit_files:
        print(f"üìÑ Found JUnit XML: {junit_files[0]}")
        final_results = parse_junit_xml(str(junit_files[0]))

    if final_results.get('total', 0) == 0:
        print("‚ö†Ô∏è No JUnit data or empty, falling back to CTest parsing")
        final_results = parse_ctest_output(build_dir)

    # 2. OVERRIDE DURATION: Always try to get the "Real" wall-clock time from CTest logs
    # Because JUnit sums up 0ms + 0ms = 0ms, but CTest knows the process took 0.12s
    real_duration = get_real_duration_from_log(build_dir)
    if real_duration > 0:
        print(f"‚è±Ô∏è  Using real duration from log: {real_duration}s")
        final_results['duration'] = real_duration
    elif final_results.get('duration', 0) == 0:
        # Fallback cosmetic if everything failed (avoid 0.00s if possible)
        final_results['duration'] = 0.01

    # Write output
    Path(output_file).parent.mkdir(parents=True, exist_ok=True)
    with open(output_file, 'w') as f: json.dump(final_results, f, indent=2)

    print(f"‚úÖ Results: {final_results['passed']}/{final_results['total']} passed in {final_results['duration']:.2f}s")
    return 0

if __name__ == '__main__': sys.exit(main())