name: Build and Tests

on:
  push:
    branches: [ dev, main ]
  pull_request:
    branches: [ dev ]

permissions:
  contents: read
  checks: write

env:
  VCPKG_TRIPLET: x64-linux
  BUILD_DIR: build
  ARTIFACTS_DIR: artifacts/tests

jobs:
  tests-and-coverage:
    name: Tests & Coverage (Linux)
    runs-on: ubuntu-latest
    env:
      BUILD_DIR: build
      ARTIFACTS_DIR: artifacts/tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git cmake ninja-build pkg-config curl zsh lcov

      - name: Cache vcpkg
        uses: actions/cache@v3
        with:
          path: |
            $HOME/vcpkg/installed
            $HOME/vcpkg/packages
            $HOME/vcpkg/buildtrees
            $HOME/vcpkg/downloads
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Cache CMake build
        uses: actions/cache@v3
        with:
          path: ${{ env.BUILD_DIR }}
          key: cmake-tests-${{ runner.os }}-${{ hashFiles('CMakeLists.txt','client/CMakeLists.txt','server/CMakeLists.txt') }}
          restore-keys: |
            cmake-tests-${{ runner.os }}-

      - name: Setup vcpkg (manifest mode)
        run: |
          chmod +x scripts/setup_vcpkg_and_cmake.sh
          ./scripts/setup_vcpkg_and_cmake.sh --triplet ${{ env.VCPKG_TRIPLET }} --no-build
        shell: bash

      - name: Configure with coverage
        run: |
          cmake -S . -B ${{ env.BUILD_DIR }} \
            -DCMAKE_TOOLCHAIN_FILE=$HOME/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_TARGET_TRIPLET=${{ env.VCPKG_TRIPLET }} \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
            -DCMAKE_EXE_LINKER_FLAGS="--coverage"

      - name: Build all targets
        run: |
          cmake --build ${{ env.BUILD_DIR }} --target r-type_client -- -j$(nproc)
          cmake --build ${{ env.BUILD_DIR }} --target r-type_server -- -j$(nproc)
          cmake --build ${{ env.BUILD_DIR }} --target client_tests -- -j$(nproc)
          cmake --build ${{ env.BUILD_DIR }} --target server_tests -- -j$(nproc)

      - name: Run tests
        run: |
          ctest --test-dir ${{ env.BUILD_DIR }} --output-on-failure -j 2

      - name: Debug test output
        if: always()
        run: |
          echo "=== Checking Testing directory ==="
          ls -la ${{ env.BUILD_DIR }}/Testing/ || true
          ls -la ${{ env.BUILD_DIR }}/Testing/Temporary/ || true
          echo "=== Checking for XML files ==="
          find ${{ env.BUILD_DIR }} -name "*.xml" -type f || true
          echo "=== Last 50 lines of LastTest.log ==="
          tail -50 ${{ env.BUILD_DIR }}/Testing/Temporary/LastTest.log || true

      - name: Parse test results
        if: always()
        run: |
          chmod +x .github/scripts/parse_test_results.py
          mkdir -p ${{ env.ARTIFACTS_DIR }}
          .github/scripts/parse_test_results.py ${{ env.BUILD_DIR }} ${{ env.ARTIFACTS_DIR }}/test-results.json

      - name: Generate coverage data
        if: always()
        run: |
          echo "::group::Generating coverage data"
          
          # Capture coverage data
          lcov --capture --directory ${{ env.BUILD_DIR }} \
            --output-file ${{ env.ARTIFACTS_DIR }}/coverage.info \
            --ignore-errors mismatch,inconsistent || true
          
          # Filter out system headers and vcpkg
          lcov --remove ${{ env.ARTIFACTS_DIR }}/coverage.info \
            '/usr/*' \
            '*/vcpkg_installed/*' \
            '*/vcpkg/*' \
            '*/tests/*' \
            --output-file ${{ env.ARTIFACTS_DIR }}/coverage-filtered.info \
            --ignore-errors unused,inconsistent || true
          
          # Keep only client and server directories
          lcov --extract ${{ env.ARTIFACTS_DIR }}/coverage-filtered.info \
            '*/client/*' \
            '*/server/*' \
            --output-file ${{ env.ARTIFACTS_DIR }}/coverage-final.info \
            --ignore-errors unused,inconsistent || true
          
          # Generate HTML report
          genhtml ${{ env.ARTIFACTS_DIR }}/coverage-final.info \
            --output-directory ${{ env.ARTIFACTS_DIR }}/coverage-html \
            --title "R-Type Code Coverage" \
            --legend --show-details || true
          
          echo "::endgroup::"
          
          # Show summary
          lcov --summary ${{ env.ARTIFACTS_DIR }}/coverage-final.info 2>&1 | tee ${{ env.ARTIFACTS_DIR }}/coverage-summary.txt || true

      - name: Parse coverage data
        if: always()
        run: |
          chmod +x .github/scripts/parse_coverage.py
          .github/scripts/parse_coverage.py \
            ${{ env.ARTIFACTS_DIR }}/coverage-final.info \
            ${{ env.ARTIFACTS_DIR }}/coverage.json \
            --include client,server

      - name: Generate GitHub summary
        if: always()
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: |
          chmod +x .github/scripts/generate_summary.py
          if [ -f ${{ env.ARTIFACTS_DIR }}/test-results.json ] && [ -f ${{ env.ARTIFACTS_DIR }}/coverage.json ]; then
            .github/scripts/generate_summary.py combined \
              ${{ env.ARTIFACTS_DIR }}/test-results.json \
              ${{ env.ARTIFACTS_DIR }}/coverage.json
          elif [ -f ${{ env.ARTIFACTS_DIR }}/test-results.json ]; then
            .github/scripts/generate_summary.py tests ${{ env.ARTIFACTS_DIR }}/test-results.json
          fi

      - name: Create combined data for Discord
        if: always()
        run: |
          if [ -f ${{ env.ARTIFACTS_DIR }}/test-results.json ] && [ -f ${{ env.ARTIFACTS_DIR }}/coverage.json ]; then
            jq -n \
              --slurpfile tests ${{ env.ARTIFACTS_DIR }}/test-results.json \
              --slurpfile coverage ${{ env.ARTIFACTS_DIR }}/coverage.json \
              '{tests: $tests[0], coverage: $coverage[0]}' \
              > ${{ env.ARTIFACTS_DIR }}/combined.json
          fi

      - name: Send Discord notification
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: |
          chmod +x .github/scripts/discord_notifier.py
          if [ -f ${{ env.ARTIFACTS_DIR }}/combined.json ]; then
            .github/scripts/discord_notifier.py combined ${{ env.ARTIFACTS_DIR }}/combined.json
          elif [ -f ${{ env.ARTIFACTS_DIR }}/test-results.json ]; then
            .github/scripts/discord_notifier.py tests ${{ env.ARTIFACTS_DIR }}/test-results.json
          fi

      - name: Check for test failures
        if: always()
        run: |
          if [ -f ${{ env.ARTIFACTS_DIR }}/test-results.json ]; then
            FAILED=$(jq -r '.failed' ${{ env.ARTIFACTS_DIR }}/test-results.json)
            if [ "$FAILED" -gt 0 ]; then
              echo "::error::$FAILED test(s) failed"
              exit 1
            fi
          fi

  analysis:
    name: C/C++ Static Analysis
    runs-on: ubuntu-latest
    needs: tests-and-coverage
    env:
      BUILD_DIR: build
      ARTIFACTS_DIR: artifacts/codeql
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git cmake ninja-build pkg-config curl cppcheck

      - name: Cache vcpkg
        uses: actions/cache@v3
        with:
          path: |
            vcpkg/installed
            vcpkg/packages
            vcpkg/buildtrees
            vcpkg/downloads
          key: vcpkg-${{ runner.os }}
          restore-keys: vcpkg-${{ runner.os }}-

      - name: Run cppcheck
        run: |
          set -o pipefail
          echo "::group::Running cppcheck"
          EXCLUDES="-i ${{ env.BUILD_DIR }}/vcpkg_installed -i client/vcpkg_installed -i server/vcpkg_installed"
          if [ -f ${{ env.BUILD_DIR }}/compile_commands.json ]; then
            cppcheck --project=${{ env.BUILD_DIR }}/compile_commands.json \
              --enable=all --inconclusive --std=c++23 \
              --xml --xml-version=2 \
              --suppress=missingIncludeSystem --suppress=checkersReport \
              $EXCLUDES 2> cppcheck.xml || true
            cppcheck --project=${{ env.BUILD_DIR }}/compile_commands.json \
              --enable=all --inconclusive --std=c++23 \
              --suppress=missingIncludeSystem --suppress=checkersReport \
              $EXCLUDES 2>&1 | tee cppcheck.txt || true
          else
            cppcheck --enable=all --inconclusive --std=c++23 \
              --xml --xml-version=2 \
              --suppress=missingIncludeSystem --suppress=checkersReport \
              $EXCLUDES client server 2> cppcheck.xml || true
            cppcheck --enable=all --inconclusive --std=c++23 \
              --suppress=missingIncludeSystem --suppress=checkersReport \
              $EXCLUDES client server 2>&1 | tee cppcheck.txt || true
          fi
          echo "::endgroup::"
          if grep -qE 'severity="(error|warning|performance)"' cppcheck.xml; then
            echo "::error::cppcheck found issues. See artifacts for details."
            sed -n '1,50p' cppcheck.txt
            exit 1
          fi
          echo "âœ“ cppcheck: no critical issues found"
      - name: Upload cppcheck results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: |
            cppcheck.xml
            cppcheck.txt
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: cpp
          queries: security-and-quality
      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v4
      - name: Upload CodeQL results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codeql-results
          path: |
            codeql-db
            codeql-sarif
            codeql-sarif/*.sarif
      - name: Generate CodeQL summary
        if: always()
        run: |
          echo "CodeQL Analysis Summary" > codeql_summary.txt
          echo "========================" >> codeql_summary.txt
          echo "" >> codeql_summary.txt
          echo "## Cppcheck Results" >> codeql_summary.txt
          echo "\`\`\`" >> codeql_summary.txt
          head -n 50 cppcheck.txt >> codeql_summary.txt
          echo "\`\`\`" >> codeql_summary.txt
          echo "" >> codeql_summary.txt
          echo "## CodeQL Results" >> codeql_summary.txt
          echo "\`\`\`" >> codeql_summary.txt
          ls -1 codeql-sarif/*.sarif >> codeql_summary.txt
          echo "\`\`\`" >> codeql_summary.txt
          echo "" >> codeql_summary.txt
          echo "## Coverage Report" >> codeql_summary.txt
          echo "\`\`\`" >> codeql_summary.txt
          lcov --summary ${{ env.ARTIFACTS_DIR }}/coverage-final.info >> codeql_summary.txt 2>&1
          echo "\`\`\`" >> codeql_summary.txt
          echo "" >> codeql_summary.txt
          echo "See attached artifacts for detailed reports." >> codeql_summary.txt
          echo "" >> codeql_summary.txt
          echo "Generated by GitHub Actions"
      - name: Upload CodeQL summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codeql-summary
          path: codeql_summary.txt
