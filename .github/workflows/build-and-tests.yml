name: Build and Tests

on:
  pull_request:
    branches: [ dev ]

permissions:
  contents: read
  checks: write

env:
  VCPKG_TRIPLET: x64-linux
  BUILD_DIR: build
  ARTIFACTS_DIR: artifacts/tests

jobs:
  analysis:
    name: C/C++ Static Analysis
    runs-on: ubuntu-latest
    env:
      BUILD_DIR: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git cmake ninja-build pkg-config curl cppcheck


      - name: Run cppcheck
        run: |
          set -o pipefail
          echo "::group::Running cppcheck"
          EXCLUDES="-i ${{ env.BUILD_DIR }}/vcpkg_installed -i client/vcpkg_installed -i server/vcpkg_installed"
          if [ -f ${{ env.BUILD_DIR }}/compile_commands.json ]; then
            cppcheck --project=${{ env.BUILD_DIR }}/compile_commands.json \
              --enable=all --inconclusive --std=c++23 \
              --xml --xml-version=2 \
              --suppress=missingIncludeSystem --suppress=checkersReport \
              $EXCLUDES 2> cppcheck.xml || true
            cppcheck --project=${{ env.BUILD_DIR }}/compile_commands.json \
              --enable=all --inconclusive --std=c++23 \
              --suppress=missingIncludeSystem --suppress=checkersReport \
              $EXCLUDES 2>&1 | tee cppcheck.txt || true
          else
            cppcheck --enable=all --inconclusive --std=c++23 \
              --xml --xml-version=2 \
              --suppress=missingIncludeSystem --suppress=checkersReport \
              $EXCLUDES client server 2> cppcheck.xml || true
            cppcheck --enable=all --inconclusive --std=c++23 \
              --suppress=missingIncludeSystem --suppress=checkersReport \
              $EXCLUDES client server 2>&1 | tee cppcheck.txt || true
          fi
          echo "::endgroup::"
          if grep -qE 'severity="(error|warning|performance)"' cppcheck.xml; then
            echo "::error::cppcheck found issues. See artifacts for details."
            sed -n '1,50p' cppcheck.txt
            exit 1
          fi
          echo "âœ“ cppcheck: no critical issues found"
      - name: Upload cppcheck results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: |
            cppcheck.xml
            cppcheck.txt
