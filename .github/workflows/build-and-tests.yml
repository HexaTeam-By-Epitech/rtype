name: Build and Tests

on:
  workflow_dispatch:

  push:
    branches: [ main, dev ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'
      - '.github/workflows/docs.yml'

  pull_request:
    branches: [ dev ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'
      - '.github/workflows/docs.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: write

env:
  VCPKG_BINARY_SOURCES: 'clear;files,/home/ubuntu/.vcpkg_binary_cache,readwrite'
  VCPKG_ROOT: ${{ github.workspace }}/vcpkg
  CC: gcc-14
  CXX: g++-14

jobs:
  build-test-analyze:
    name: Build, Analysis & Coverage
    runs-on: [self-hosted, gcp-spot]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git cmake ninja-build pkg-config \
            cppcheck gcc-14 g++-14 lcov gcovr \
            libx11-dev libxrandr-dev libxcursor-dev libxi-dev \
            libudev-dev libgl1-mesa-dev libopenal-dev \
            libflac-dev libvorbis-dev \
            libxinerama-dev xorg-dev libglu1-mesa-dev python3

      - name: Prepare persistent cache
        run: mkdir -p /home/ubuntu/.vcpkg_binary_cache

      - name: Bootstrap vcpkg
        run: ./vcpkg/bootstrap-vcpkg.sh -disableMetrics

      - name: Configure CMake (Release)
        run: |
          cmake --preset linux-release \
            -DCMAKE_C_COMPILER=${{ env.CC }} \
            -DCMAKE_CXX_COMPILER=${{ env.CXX }} \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build Release
        run: cmake --build --preset linux-release -j$(nproc)

      - name: Run cppcheck
        run: |
          set -o pipefail
          BUILD_PATH="build/linux-release"
          EXCLUDES="-i ${BUILD_PATH}/vcpkg_installed"
          
          cppcheck --project=${BUILD_PATH}/compile_commands.json \
            --enable=warning,style,performance,portability \
            --inconclusive \
            --std=c++23 \
            --xml --xml-version=2 \
            --suppress=missingIncludeSystem \
            --suppress=checkersReport \
            --suppress=unmatchedSuppression \
            $EXCLUDES 2> cppcheck.xml || true
          
          cppcheck --project=${BUILD_PATH}/compile_commands.json \
            --enable=warning,style,performance,portability \
            --inconclusive \
            --std=c++23 \
            --suppress=missingIncludeSystem \
            --suppress=checkersReport \
            --suppress=unmatchedSuppression \
            --template='{file}:{line}:{column}: {severity}: {message} [{id}]' \
            $EXCLUDES 2>&1 | tee cppcheck.txt || true
          
          ERROR_COUNT=$(grep -c 'severity="error"' cppcheck.xml || true)
          WARNING_COUNT=$(grep -c 'severity="warning"' cppcheck.xml || true)
          
          if [ "$ERROR_COUNT" -gt 0 ]; then
            head -20 cppcheck.txt
            exit 1
          fi

      - name: Upload cppcheck results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: |
            cppcheck.xml
            cppcheck.txt
          retention-days: 30

      - name: Upload binaries
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: binaries-release
          path: |
            build/linux-release/server/r-type_server
            build/linux-release/client/r-type_client
          retention-days: 7

      - name: Configure CMake (Coverage)
        run: |
          cmake --preset linux-debug \
            -DCMAKE_C_COMPILER=${{ env.CC }} \
            -DCMAKE_CXX_COMPILER=${{ env.CXX }} \
            -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
            -DCMAKE_C_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
            -DCMAKE_EXE_LINKER_FLAGS="--coverage"

      - name: Build Coverage
        run: cmake --build --preset linux-debug -j$(nproc)

      - name: Run tests
        run: ctest --preset linux-debug --verbose --timeout 300 --output-junit test-results.xml

      - name: Generate coverage data
        working-directory: build/linux-debug
        run: |
          lcov --gcov-tool /usr/bin/gcov-14 --capture \
            --directory . \
            --output-file coverage.info \
            --rc branch_coverage=1 \
            --ignore-errors mismatch
          
          lcov --extract coverage.info \
            '${{ github.workspace }}/client/*' \
            '${{ github.workspace }}/server/*' \
            --output-file coverage_project.info \
            --rc branch_coverage=1 \
            --ignore-errors unused
          
          lcov --remove coverage_project.info \
            '/usr/*' \
            '${{ github.workspace }}/build/linux-debug/vcpkg_installed/*' \
            --output-file coverage_filtered.info \
            --rc branch_coverage=1 \
            --ignore-errors empty,unused
          
          if ! grep -q '^SF:' coverage_filtered.info; then
            cp coverage_project.info coverage_filtered.info
          fi

          genhtml coverage_filtered.info \
            --output-directory coverage_html \
            --rc branch_coverage=1

      - name: Parse test results
        run: |
          python3 .github/scripts/parse_test_results.py \
            build/linux-debug \
            test-results.json

      - name: Parse coverage results
        run: |
          python3 .github/scripts/parse_coverage.py \
            build/linux-debug/coverage_filtered.info \
            coverage.json \
            --include client,server

      - name: Prepare combined results
        if: always()
        run: |
          if [ -f test-results.json ] && [ -f coverage.json ]; then
            jq -s '{"tests": .[0], "coverage": .[1]}' test-results.json coverage.json > combined-results.json
          else
            echo '{"error": "Missing reports"}' > combined-results.json
          fi

      - name: Generate GitHub Summary
        run: |
          python3 .github/scripts/generate_summary.py \
            combined \
            test-results.json \
            coverage.json

      - name: Send Discord notification
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            python3 .github/scripts/discord_notifier.py \
              combined \
              combined-results.json
          fi
        continue-on-error: true

      - name: Check test results
        run: |
          FAILED=$(jq -r '.failed' test-results.json)
          TOTAL=$(jq -r '.total' test-results.json)
          if [ "$FAILED" -gt 0 ]; then
            exit 1
          fi
          if [ "$TOTAL" -eq 0 ]; then
            exit 1
          fi

      - name: Check Coverage and Prepare Badge
        run: |
          LINE_COV=$(jq -r '.line_coverage' coverage.json)
          echo "COVERAGE_VAL=${LINE_COV%.*}%" >> $GITHUB_ENV
          
          if (( $(echo "$LINE_COV >= 80" | bc -l) )); then
            echo "COVERAGE_COLOR=green" >> $GITHUB_ENV
          elif (( $(echo "$LINE_COV >= 60" | bc -l) )); then
            echo "COVERAGE_COLOR=yellow" >> $GITHUB_ENV
          else
            echo "COVERAGE_COLOR=red" >> $GITHUB_ENV
          fi
          
          THRESHOLD=60.0
          if (( $(echo "$LINE_COV < $THRESHOLD" | bc -l) )); then
             echo "::warning::Coverage ${LINE_COV}% is below threshold ${THRESHOLD}%"
          fi

      - name: Update Coverage Badge
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: b7449f68c0857ebff4c2c848415dc9f8
          filename: rtype-coverage.json
          label: coverage
          message: ${{ env.COVERAGE_VAL }}
          color: ${{ env.COVERAGE_COLOR }}
          namedLogo: c++

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: |
            test-results.json
            coverage.json
            combined-results.json
            build/linux-debug/coverage_html/
          retention-days: 30