name: Build and Tests

on:
  pull_request:
    branches: [ dev ]
  push:
    branches: [ dev ]

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  VCPKG_BINARY_SOURCES: "clear;nuget,GitHub,readwrite"
  BUILD_DIR: build
  CC: gcc-13
  CXX: g++-13

jobs:
  build-and-analysis:
    name: Build & Static Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git cmake ninja-build pkg-config curl zip unzip tar \
            cppcheck gcc-13 g++-13 \
            libx11-dev libxrandr-dev libxcursor-dev libxi-dev \
            libudev-dev libgl1-mesa-dev libopenal-dev \
            libflac-dev libvorbis-dev

      - name: Setup vcpkg
        uses: microsoft/setup-vcpkg@v1
        with:
          manifestPath: vcpkg.json
          cacheBinary: true
          cacheHitVar: VCPKG_CACHE_HIT

      - name: Log vcpkg cache status
        run: |
          echo "VCPKG_CACHE_HIT: $VCPKG_CACHE_HIT" >> $GITHUB_STEP_SUMMARY
          echo "VCPKG_CACHE_HIT: $VCPKG_CACHE_HIT"

      - name: Cache CMake build
        id: cmake-cache
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_DIR }}
          key: cmake-release-${{ runner.os }}-${{ hashFiles('CMakeLists.txt', 'vcpkg.json') }}
          restore-keys: |
            cmake-release-${{ runner.os }}-

      - name: Log CMake cache status
        run: |
          echo "CMAKE_CACHE_HIT: ${{ steps.cmake-cache.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY
          echo "CMAKE_CACHE_HIT: ${{ steps.cmake-cache.outputs.cache-hit }}"

      - name: Configure CMake
        if: steps.cmake-cache.outputs.cache-hit != 'true'
        run: |
          cmake -B ${{ env.BUILD_DIR }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=${{ env.CC }} \
            -DCMAKE_CXX_COMPILER=${{ env.CXX }} \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            -DVCPKG_TARGET_TRIPLET=x64-linux \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build project
        if: steps.cmake-cache.outputs.cache-hit != 'true'
        run: cmake --build ${{ env.BUILD_DIR }} --config Release -j$(nproc)

      - name: Run cppcheck
        run: |
          set -o pipefail
          echo "::group::Running cppcheck with compile_commands.json"
          
          EXCLUDES="-i ${{ env.BUILD_DIR }}/vcpkg_installed"
          
          cppcheck --project=${{ env.BUILD_DIR }}/compile_commands.json \
            --enable=warning,style,performance,portability \
            --inconclusive \
            --std=c++23 \
            --xml --xml-version=2 \
            --suppress=missingIncludeSystem \
            --suppress=checkersReport \
            --suppress=unmatchedSuppression \
            $EXCLUDES 2> cppcheck.xml || true
          
          cppcheck --project=${{ env.BUILD_DIR }}/compile_commands.json \
            --enable=warning,style,performance,portability \
            --inconclusive \
            --std=c++23 \
            --suppress=missingIncludeSystem \
            --suppress=checkersReport \
            --suppress=unmatchedSuppression \
            --template='{file}:{line}:{column}: {severity}: {message} [{id}]' \
            $EXCLUDES 2>&1 | tee cppcheck.txt || true
          
          echo "::endgroup::"
          
          ERROR_COUNT=$(grep -c 'severity="error"' cppcheck.xml || true)
          WARNING_COUNT=$(grep -c 'severity="warning"' cppcheck.xml || true)
          
          echo "::notice::Cppcheck found $ERROR_COUNT error(s) and $WARNING_COUNT warning(s)"
          
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "::error::cppcheck found $ERROR_COUNT critical error(s)"
            head -20 cppcheck.txt
            exit 1
          fi
          
          if [ "$WARNING_COUNT" -gt 15 ]; then
            echo "::warning::cppcheck found $WARNING_COUNT warnings (threshold: 15)"
          fi
          
          echo "✓ Static analysis passed"

      - name: Upload cppcheck results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: |
            cppcheck.xml
            cppcheck.txt
          retention-days: 30

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: binaries-release
          path: |
            ${{ env.BUILD_DIR }}/server/r-type_server
            ${{ env.BUILD_DIR }}/client/r-type_client
          retention-days: 7

  tests-and-coverage:
    name: Tests & Coverage
    runs-on: ubuntu-latest
    needs: build-and-analysis

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build \
            gcc-13 g++-13 lcov gcovr \
            libx11-dev libxrandr-dev libxcursor-dev libxi-dev \
            libudev-dev libgl1-mesa-dev libopenal-dev \
            libflac-dev libvorbis-dev python3

      - name: Setup vcpkg
        uses: microsoft/setup-vcpkg@v1
        with:
          manifestPath: vcpkg.json
          cacheBinary: true
          cacheHitVar: VCPKG_CACHE_HIT

      - name: Log vcpkg cache status
        run: |
          echo "VCPKG_CACHE_HIT: $VCPKG_CACHE_HIT" >> $GITHUB_STEP_SUMMARY
          echo "VCPKG_CACHE_HIT: $VCPKG_CACHE_HIT"

      - name: Cache CMake build
        id: cmake-cache
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_DIR }}
          key: cmake-debug-coverage-${{ runner.os }}-${{ hashFiles('CMakeLists.txt', 'vcpkg.json') }}
          restore-keys: |
            cmake-debug-coverage-${{ runner.os }}-

      - name: Log CMake cache status
        run: |
          echo "CMAKE_CACHE_HIT: ${{ steps.cmake-cache.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY
          echo "CMAKE_CACHE_HIT: ${{ steps.cmake-cache.outputs.cache-hit }}"

      - name: Configure CMake with Coverage
        run: |
          cmake -B ${{ env.BUILD_DIR }} \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=${{ env.CC }} \
            -DCMAKE_CXX_COMPILER=${{ env.CXX }} \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            -DVCPKG_TARGET_TRIPLET=x64-linux \
            -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
            -DCMAKE_C_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
            -DCMAKE_EXE_LINKER_FLAGS="--coverage"

      - name: Build project with coverage
        run: cmake --build ${{ env.BUILD_DIR }} --config Debug -j$(nproc)

      - name: Run tests
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          ctest --output-on-failure --verbose --timeout 300 || true

      - name: Generate coverage data
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          echo "Generating LCOV coverage data..."
          lcov --capture \
            --directory . \
            --output-file coverage.info \
            --rc lcov_branch_coverage=1 \
            --ignore-errors mismatch || true
          
          lcov --remove coverage.info \
            '/usr/*' \
            '*/vcpkg_installed/*' \
            '*/build/*' \
            '*/tests/*' \
            --output-file coverage_filtered.info \
            --rc lcov_branch_coverage=1 || true
          
          genhtml coverage_filtered.info \
            --output-directory coverage_html \
            --rc lcov_branch_coverage=1 || true
          
          echo "Coverage report generated"

      - name: Parse test results
        run: |
          python3 .github/scripts/parse_test_results.py \
            ${{ env.BUILD_DIR }} \
            test-results.json

      - name: Parse coverage results
        run: |
          python3 .github/scripts/parse_coverage.py \
            ${{ env.BUILD_DIR }}/coverage_filtered.info \
            coverage.json \
            --include client,server

      - name: Prepare combined results for Discord
        if: always()
        run: |
          jq -s '{"tests": .[0], "coverage": .[1]}' \
            test-results.json \
            coverage.json > combined-results.json
          
          echo "✅ Combined results created"
          ls -lh combined-results.json

      - name: Generate GitHub Summary
        run: |
          python3 .github/scripts/generate_summary.py \
            combined \
            test-results.json \
            coverage.json

      - name: Send Discord notification
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            if [ -f "combined-results.json" ]; then
              python3 .github/scripts/discord_notifier.py \
                combined \
                combined-results.json
            else
              echo "❌ combined-results.json not found, skipping Discord notification"
            fi
          else
            echo "⚠️  DISCORD_WEBHOOK not set, skipping notification"
          fi
        continue-on-error: true

      - name: Check test results
        run: |
          FAILED=$(jq -r '.failed' test-results.json)
          TOTAL=$(jq -r '.total' test-results.json)
          
          echo "Tests: $FAILED failed out of $TOTAL total"
          
          if [ "$FAILED" -gt 0 ]; then
            echo "::error::$FAILED test(s) failed"
            exit 1
          fi
          
          if [ "$TOTAL" -eq 0 ]; then
            echo "::warning::No tests were run"
            exit 1
          fi
          
          echo "✓ All tests passed"

      - name: Check coverage threshold
        run: |
          LINE_COV=$(jq -r '.line_coverage' coverage.json)
          THRESHOLD=60.0
          
          echo "Line coverage: ${LINE_COV}%"
          
          if (( $(echo "$LINE_COV < $THRESHOLD" | bc -l) )); then
            echo "::warning::Coverage ${LINE_COV}% is below threshold ${THRESHOLD}%"
          else
            echo "✓ Coverage meets threshold"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results.json
            ${{ env.BUILD_DIR }}/Testing/
          retention-days: 30

      - name: Upload coverage results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.json
            ${{ env.BUILD_DIR }}/coverage_filtered.info
            ${{ env.BUILD_DIR }}/coverage_html/
          retention-days: 30

      - name: Upload combined results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: combined-results
          path: combined-results.json
          retention-days: 30