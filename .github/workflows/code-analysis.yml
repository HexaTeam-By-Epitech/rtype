name: Code Analysis

on:
  push:
    branches: [ dev, main ]
  pull_request:
    branches: [ dev ]

permissions:
  contents: read
  security-events: write
  checks: write
  actions: read

env:
  VCPKG_TRIPLET: x64-linux
  BUILD_DIR: build-codeql
  ARTIFACTS_DIR: artifacts/codeql

jobs:
  analysis:
    name: C/C++ Static Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git cmake ninja-build pkg-config curl cppcheck

      - name: Cache vcpkg
        uses: actions/cache@v3
        with:
          path: |
            $HOME/vcpkg/installed
            $HOME/vcpkg/packages
            $HOME/vcpkg/buildtrees
            $HOME/vcpkg/downloads
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-${{ runner.os }}-

      - name: Cache build directory
        uses: actions/cache@v3
        with:
          path: ${{ env.BUILD_DIR }}
          key: codeql-build-${{ runner.os }}-${{ hashFiles('CMakeLists.txt','client/CMakeLists.txt','server/CMakeLists.txt') }}
          restore-keys: codeql-build-${{ runner.os }}-

      - name: Setup vcpkg
        run: |
          chmod +x scripts/setup_vcpkg_and_cmake.sh
          ./scripts/setup_vcpkg_and_cmake.sh --triplet ${{ env.VCPKG_TRIPLET }} --no-build
        shell: bash

      - name: Configure CMake
        run: |
          cmake -S . -B ${{ env.BUILD_DIR }} \
            -DCMAKE_TOOLCHAIN_FILE=$HOME/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_TARGET_TRIPLET=${{ env.VCPKG_TRIPLET }} \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_BUILD_TYPE=Debug

      - name: Run cppcheck
        run: |
          set -o pipefail
          echo "::group::Running cppcheck"
          
          EXCLUDES="--exclude=${{ env.BUILD_DIR }}/vcpkg_installed --exclude=client/vcpkg_installed --exclude=server/vcpkg_installed"
          
          if [ -f ${{ env.BUILD_DIR }}/compile_commands.json ]; then
            # XML output for artifact
            cppcheck --project=${{ env.BUILD_DIR }}/compile_commands.json \
              --enable=all --inconclusive --std=c++23 \
              --xml --xml-version=2 \
              --suppress=missingIncludeSystem --suppress=checkersReport \
              $EXCLUDES 2> cppcheck.xml || true
          
            # Human-readable output
            cppcheck --project=${{ env.BUILD_DIR }}/compile_commands.json \
              --enable=all --inconclusive --std=c++23 \
              --suppress=missingIncludeSystem --suppress=checkersReport \
              $EXCLUDES 2>&1 | tee cppcheck.txt || true
          else
            cppcheck --enable=all --inconclusive --std=c++23 \
              --xml --xml-version=2 \
              --suppress=missingIncludeSystem --suppress=checkersReport \
              $EXCLUDES client server 2> cppcheck.xml || true
          
            cppcheck --enable=all --inconclusive --std=c++23 \
              --suppress=missingIncludeSystem --suppress=checkersReport \
              $EXCLUDES client server 2>&1 | tee cppcheck.txt || true
          fi
          
          echo "::endgroup::"
          
          # Check for serious issues
          if grep -qE 'severity="(error|warning|performance)"' cppcheck.xml; then
            echo "::error::cppcheck found issues. See artifacts for details."
            sed -n '1,50p' cppcheck.txt
            exit 1
          fi
          
          echo "âœ“ cppcheck: no critical issues found"

      - name: Upload cppcheck results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: |
            cppcheck.xml
            cppcheck.txt

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: cpp
          queries: security-and-quality

      - name: Build project
        run: cmake --build ${{ env.BUILD_DIR }} -- -j$(nproc)

      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v4

      - name: Gather CodeQL SARIF files
        id: gather_sarif
        if: always()
        run: |
          set -eux
          mkdir -p ${{ env.ARTIFACTS_DIR }}
          echo "::group::Searching for SARIF files"
          
          found=0
          for search_dir in "$GITHUB_WORKSPACE" "$RUNNER_WORKSPACE" "$GITHUB_WORKSPACE/.."; do
            if [ -d "$search_dir" ]; then
              while IFS= read -r -d $'\0' f; do
                echo "Found: $f"
                cp -f "$f" ${{ env.ARTIFACTS_DIR }}/ || true
                found=1
              done < <(find "$search_dir" -maxdepth 6 -type f -name '*.sarif' -print0 2>/dev/null || true)
            fi
          done
          
          echo "::endgroup::"
          
          if [ "$found" -eq 1 ]; then
            echo "has_files=true" >> "$GITHUB_OUTPUT"
            ls -lah ${{ env.ARTIFACTS_DIR }}
          else
            echo "has_files=false" >> "$GITHUB_OUTPUT"
            echo "::warning::No SARIF files found"
          fi

      - name: Summarize CodeQL results
        if: always()
        run: |
          chmod +x .github/scripts/summarize_codeql.py
          .github/scripts/summarize_codeql.py

      - name: Publish CodeQL summary
        if: always()
        run: |
          chmod +x .github/scripts/publish_codeql_summary.py
          .github/scripts/publish_codeql_summary.py

      - name: Send Discord notification
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: |
          chmod +x .github/scripts/send_discord_notification.py
          .github/scripts/send_discord_notification.py

      - name: Check for critical findings
        if: always()
        run: |
          chmod +x .github/scripts/fail_on_codeql.py
          .github/scripts/fail_on_codeql.py

      - name: Prepare PR comment
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        run: |
          mkdir -p ${{ env.ARTIFACTS_DIR }}
          {
            echo "## ðŸ” CodeQL Analysis Results"
            echo ""
            if [ -f ${{ env.ARTIFACTS_DIR }}/codeql-summary.txt ]; then
              echo "### Top Findings"
              echo '```'
              head -n 20 ${{ env.ARTIFACTS_DIR }}/codeql-summary.txt
              echo '```'
            else
              echo "âœ… No findings or summary not available."
            fi
            echo ""
            echo "---"
            echo "ðŸ“¦ Full report available in workflow artifacts: \`codeql-sarif\`"
          } > ${{ env.ARTIFACTS_DIR }}/comment-body.md

      - name: Post PR comment
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          issue-number: ${{ github.event.pull_request.number }}
          body-file: ${{ env.ARTIFACTS_DIR }}/comment-body.md

      - name: Upload CodeQL artifacts
        if: always() && steps.gather_sarif.outputs.has_files == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: codeql-sarif
          path: ${{ env.ARTIFACTS_DIR }}