name: Windows Build

on:
  workflow_dispatch:

  push:
    branches: [ feat/common/build-support-windows ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'
      - '.github/workflows/docs.yml'
      - '.github/workflows/mirror.yml'

  pull_request:
    branches: [ dev ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'
      - '.github/workflows/docs.yml'
      - '.github/workflows/mirror.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: write

env:
  VCPKG_BINARY_SOURCES: 'clear;x-azblob,https://vcpkgcache.blob.core.windows.net/cache,readwrite'
  VCPKG_ROOT: ${{ github.workspace }}/vcpkg

jobs:
  build-windows:
    name: Build on Windows (MSVC)
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        build_type: [Debug, Release]
        include:
          - build_type: Debug
            preset: windows-debug
          - build_type: Release
            preset: windows-release

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.27.x'

      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@master

      - name: Setup vcpkg cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/vcpkg/installed
            ${{ github.workspace }}/vcpkg/packages
            ${{ github.workspace }}/build/${{ matrix.preset }}/vcpkg_installed
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-

      - name: Bootstrap vcpkg
        shell: cmd
        run: |
          cd vcpkg
          call bootstrap-vcpkg.bat -disableMetrics
          cd ..

      - name: Configure CMake
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          cmake --preset ${{ matrix.preset }}

      - name: Build
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          cmake --build build/${{ matrix.preset }} --config ${{ matrix.build_type }} --parallel

      - name: List build artifacts
        shell: powershell
        run: |
          Write-Host "=== Server artifacts ==="
          Get-ChildItem -Path "build/${{ matrix.preset }}/server" -Recurse -Include *.exe,*.dll
          Write-Host "`n=== Client artifacts ==="
          Get-ChildItem -Path "build/${{ matrix.preset }}/client" -Recurse -Include *.exe,*.dll

      - name: Run tests (Debug only)
        if: matrix.build_type == 'Debug'
        shell: cmd
        working-directory: build/${{ matrix.preset }}
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          ctest --output-on-failure --timeout 300 -C Debug

      - name: Upload binaries
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.build_type }}-binaries
          path: |
            build/${{ matrix.preset }}/server/*.exe
            build/${{ matrix.preset }}/client/*.exe
            build/${{ matrix.preset }}/server/*.dll
            build/${{ matrix.preset }}/client/*.dll
          retention-days: 7

      - name: Upload test results
        if: matrix.build_type == 'Debug' && always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-test-results
          path: |
            build/${{ matrix.preset }}/Testing/
          retention-days: 7

  build-windows-mingw:
    name: Build on Windows (MinGW)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MinGW
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-make
            git

      - name: Setup vcpkg cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/vcpkg/installed
            ${{ github.workspace }}/vcpkg/packages
            ${{ github.workspace }}/build/windows-mingw-debug/vcpkg_installed
          key: ${{ runner.os }}-mingw-vcpkg-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            ${{ runner.os }}-mingw-vcpkg-

      - name: Bootstrap vcpkg
        shell: msys2 {0}
        run: |
          cd vcpkg
          ./bootstrap-vcpkg.sh -disableMetrics
          cd ..

      - name: Configure CMake
        shell: msys2 {0}
        run: |
          cmake --preset windows-mingw-debug

      - name: Build
        shell: msys2 {0}
        run: |
          cmake --build build/windows-mingw-debug --parallel

      - name: Run tests
        shell: msys2 {0}
        working-directory: build/windows-mingw-debug
        run: |
          ctest --output-on-failure --timeout 300

      - name: Upload binaries
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: windows-mingw-binaries
          path: |
            build/windows-mingw-debug/server/*.exe
            build/windows-mingw-debug/client/*.exe
          retention-days: 7

  status-check:
    name: Windows Build Status
    runs-on: ubuntu-latest
    needs: [build-windows, build-windows-mingw]
    if: always()

    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.build-windows.result }}" != "success" ] && [ "${{ needs.build-windows-mingw.result }}" != "success" ]; then
            echo "❌ All Windows builds failed"
            exit 1
          elif [ "${{ needs.build-windows.result }}" != "success" ]; then
            echo "⚠️ MSVC build failed, but MinGW succeeded"
            exit 0
          elif [ "${{ needs.build-windows-mingw.result }}" != "success" ]; then
            echo "⚠️ MinGW build failed, but MSVC succeeded"
            exit 0
          else
            echo "✅ All Windows builds succeeded"
            exit 0
          fi

